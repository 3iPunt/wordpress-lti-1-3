<?php session_start(); ?>
<div class="container">
<div class="box" id="registerbox">
    <h3>Register</h3>
    <ul>
        <li>
            <lable>Key Set URL</lable>
            <input id="key-set" type="text" name="key_set_url" value="https://lti-ri.imsglobal.org/platforms/69/platform_keys/61.json" />
        </li>
        <li>
            <lable>Auth Token URL</lable>
            <input id="auth-token" type="text" name="auth_token_url" value="https://lti-ri.imsglobal.org/platforms/69/access_tokens" />
        </li>
        <li>
            <lable>Private Key</lable>
            <textarea id="priv-key" type="text" name="private_key" placeholder="Use Tool Key" >-----BEGIN RSA PRIVATE KEY-----
MIIJJwIBAAKCAgEAr61O2l0KcCtccfviPvMatnG4xA3EMpWV6Aln6xocmwNkcZC3
FJTTfKVjpruZeM2DScsak3Wg01h7A6EFRcv/JH90xoammvx4YYzyZE0w6LYHJnZu
40vXUCt18KavJU2hZfl7gadcTloWQDcAzDXCgBS6lCQIDY3/XpjSzEiLMQzk13uU
DaT8ad94ydj0Lbpa45QdQFDK5jAjZ40Zl72F+FBNr7Plf2DuqOCDDi14GAvxG3NB
Ed+aPOPjT+WxnZchxLzvl5otyCJ0sgvnjGBlPy0UwwJlyGSt0Z+4Sb7z+PtL7QSS
QI3n8NiSOfn9EvzIufUa/7NcKi435LUoH140vhQdE858BlSTcDQx3gQCLNfUk12M
CzCTg5//VEqBmXVvW0+UZINevQH3nFdpF9GMqAiJnJ9zpOkWZz7E4ZVWQJSmXEmX
ywSqVu9RzoH8pSYA2hynvvFlfUtoNSK0Gp+koHI3D9ajNXrVkXF1VUKAKXEa7OVs
HrhRMQ3c5bSxXR+dkpb2EWbYFFcXC77fsK5M4Rj8ALRldnqBkHEuQw2fDLimEqbT
Y9lcB6IKFuv58Mb++8/bdjRZfdRC4EX38427HskWwxROmJdVdKvbBUBMY5qMQoAK
mhcX0+Nwb4B02b+MPpAWuL6gGyg4j9zVkt1dKsJpXVlMdEuFEidwhb+hbu0CAwEA
AQKCAgByBALXSedKYXoAKD/wJwtBOZF2/JBHXDoMfH5LYYkLOipoYknQO77+eMCy
J7M1afw5Wm4HIiKcyCIeetTXNcyDvYzmg+GBWTYv6bAvVMHXZrxBREA3mLNHPs2u
wB+QEFAdxMtZnGsWFvW1+3yzDHkNc2acWr43Pd9tX7YAC1z7GqkzCOtP57JCbF0S
c5IWU4pFhY1ufoEQ4FE6FaN0jfZy8Hta+2CJSTnbtMqZ2vzEbouvCyBCH2MU/bo7
0pFx+/JYo17Ef7YS2/nszDkdLDrJw9Jjthyk8GK3V/fdNOdWwpHGZF8fMnpEH+rX
Yd3UAuereN5q8ddxMMnpz4EYyqVjXE0TrlLrDHXFuXKnzH7W9apUj8gMfOLVc+TB
aQajR602+lG3/JWe44Fg4ony6zuh35XVYYV30yfm82X4rRhtMFDOT/ERovjIiK4A
URZEK4kD1QPK9NqZ/FOI1ZM1M872vTE7CF+C7AkJExkNNYhkwbr31BJq9eNLuG8f
UmR3xSM4iN8+reoPZq9pocfPsk86mw18IwHGl71oyv4DJ8z2iDGBxaCRA8tcbcxK
71TPn6tZE1VaKNc/uZHiM3nGxt2MCVloJBUmvQGNbTclQ28F0JY03fePkkhRHGYq
nSrwbRpNLQ/a+0oWKYLkxNFZ204Riy+vX+XubKaWr+q9Gm0zgQKCAQEA3h2Y/CDG
fAt1QISRY7VNpis2sYaG7c0TGEMck9LIRVF513Il/+vIw3HHIYhVGm1soPnWVjZF
jErCowxI6s//rMw2kOzFvEKHb47ykpdtqQzvI2X+GjxLPwEuiJaJIvf4F38lFuDm
pb+M1wehxQlU9Tm6cnKxKfrXwJDAc3O9TiDCE4Y22afHUJDhZ1z9UawMWkkuoaPQ
rW1TtnqewMUHe1mgkRpPMvRptLdK6Wn7wFjXVjEIVLBKrgZgDHViDDHAIunjWR9/
cP+euflleLUJY4PYZ3fQIanjdtpWGsCPH1d+uPgIWIWJoO9YeM8dnaG0NiVwYzDg
DU7qvFsHK0EMMQKCAQEAynoeATPXtrmiMUtUyuvE6cpUxlTp9Z6LpWsT1+foqLd8
hrT3cVKyarLTj9Qi+LXsBbw1/1ASEP9X1nhgT/8POQVC+tdt40ngXeJ2ojU3SN8r
TS8emJrlYGDhNQNMRxhH7wH4SyYvzXdxN1Xs5KCZIGiuVQL90p/EeQlQsFXd36ZP
Oxr37Ys5RH/564zZ8OlpRecB+rGzUnEUJhIcU5eGEa/QmI5FjlDK52ig3sCkjYjZ
1s8M06axTwiVtx7os4auERItkXqB/quTYqHrT5/eDR5QVbiQrGxRWGE8nFtchnQf
8F5CKkuf0b5BLcu/VduGkv+32s+e9wEJawDO2aZrfQKCAQB3oXVehsCg2wMCBuTP
0TzLPQcuQoi11/hq3uqra6HWQ/Xd5ms1FeeB7OwV0XoUy87wPOAGeyCmWTXP37P+
VJ0ekrbpA73UkfikS1e3QLwdiwvaAvsDYmocuyQ3CO0/2lLTRPXTBrrzluHihwfI
Oih6E+ep8MAfHi3KV6xwAmx5ggdFwMoWHNmrOP1OULVXodTdZAErqjGg1vt5kz2i
EfzfoPxsasExbpbocLh2U1D23mLM14fnJTRz2pcs3qQ6cSlNJLAAtohLckIpZHwU
sV0nLkIGKG//UaNjxmEN85yigtuMAHtuQi5IceEy4ErRNeD8MNoBcreaM2EWpeiM
kXJhAoIBAA1Q1qRRmoAj2SzQvXTS6JJPgh/A+dnzYU+xqQ5r6/schg393MARJjaq
KAuvcdVVcX43EH4H8Ag6IrayF/Nq3L9tPyhr/ogSFbVW7WJhiY87Tge3b5WtqiQa
evUXkG6khCaNxJx8mGw0zLdM6VVn0mo1ODHTDopJg4xKNopCO2M39sH2VhPDMjL1
D6SUEMktMIUuWgz4nshvM1oFmuNMdb64B0nhIWXonk91rA66MJg2Rc1AtKE+ty5x
bBcs6zTTSKNKxMBqhB4RfpHgAC+uXdYTBkl859bPENJ1Ip1NzNnyzR7rtAJAEvSi
RHsUiTLGSyVjt92mBdhMsyfcV74smakCggEAPG7R8xSnlYuY/igAmLr7nnVFCdaA
wf3S8EdyxAOqjbNJjbMeRxhBoNbLpjuPXox9CojyX/0NG7G4w/ZAD0NdIR0JB6Xs
qlcZTjeFbawovnh7lrjVBYYhGiZxNfzNu47WNGzaS++za10lPHEwpp898X6O2uVt
6n+5mKXv94uRwhIQuzlxiS/Ui/HlLvEUBEYSCBGNg47+TEx5didyw8aJ5sUaFj93
0ysbT8PKSiQzK7sZvJLtthJ/CfiK+bZMCebGhrq8dDR5qnq6Yqi3bPI9j0NxK455
dvWBwKotNuVRtoLCuTMXmkyEhJYfab2tIn+UW+QQq8jxcyycPHG6ORudcg==
-----END RSA PRIVATE KEY-----</textarea>
        </li>
        <li>
            <input type="submit" value="Go!" onclick="register();" />
        </li>
    </ul>
</div>

<div class="box" id="deploybox">
    <h3>Deploy</h3>
    <ul>
        <li>
            <input id="account-input" type="text" name="account" value="" placeholder="Account" />
            <span class="help-icon" title="Account to link with Deplyment: <?= $jwt_body['https://purl.imsglobal.org/spec/lti/claim/deployment_id'] ?>">?</span>
        </li>
        <li>
            <input type="submit" value="Go!" onclick="deploy();" />
        </li>
    </ul>
</div>

<div class="box" id="donebox">
    <?php if (empty($jwt_body['https://purl.imsglobal.org/spec/lti/claim/launch_presentation']['return_url'])) { ?>
        <srtrong>Deployment complete, please relaunch.</strong>
    <?php } else { ?>
        <form method="GET" action="<?= $jwt_body['https://purl.imsglobal.org/spec/lti/claim/launch_presentation']['return_url'] ?>">
            <input type="submit" value="Done" />
        </form>
    <?php } ?>
</div>

<div class="box" id="messagebox">
</div>
</div>

<script>
function deploy() {
    var xhttp = new XMLHttpRequest();
    var query = 'deployment_id=<?= $jwt_body['https://purl.imsglobal.org/spec/lti/claim/deployment_id'] ?>';
    query += '&iss=<?= $jwt_body['iss'] ?>';
    query += '&client_id=<?= $client_id ?>';
    query += '&account=' + encodeURIComponent(document.getElementById('account-input').value);
    query += '&deployment=true';
    xhttp.open("POST", "deploy.php?" + query, false);
    xhttp.send();
    document.getElementById('deploybox').style = '';
    document.getElementById('donebox').style = 'display:block';
    document.getElementById('messagebox').innerHTML = '<?= $jwt_body['https://purl.imsglobal.org/spec/lti/claim/deployment_id'] ?> deployed to account '
        + encodeURIComponent(document.getElementById('account-input').value);
}

function register() {
    var xhttp = new XMLHttpRequest();
    var query = 'deployment_id=<?= $jwt_body['https://purl.imsglobal.org/spec/lti/claim/deployment_id'] ?>';
    query += '&iss=<?= $jwt_body['iss'] ?>';
    query += '&client_id=<?= $client_id ?>';
    query += '&key_set_url=' + encodeURIComponent(document.getElementById('key-set').value);
    query += '&auth_token_url=' + encodeURIComponent(document.getElementById('auth-token').value);
    query += '&private_key=' + encodeURIComponent(document.getElementById('priv-key').value);
    query += '&registration=true';
    xhttp.open("POST", "register.php?" + query, false);
    xhttp.send();
    document.getElementById('registerbox').style = '';
    document.getElementById('deploybox').style = "display:block";
    document.getElementById('messagebox').innerHTML = '<?= $client_id ?> registerd to <?= $jwt_body['iss'] ?>';
}

var registered = <?= empty($_SESSION['issuers'][$_REQUEST['iss']]['clients'][$_REQUEST['client_id']]) ? 'false' : 'true' ?>

if (!registered) {
    document.getElementById('registerbox').style = "display:block";
} else {
    document.getElementById('deploybox').style = "display:block";
}
eval('session = <?= json_encode($_SESSION) ?>');
console.log(session);
</script>

<style>
    body {
        font-family: 'Tahoma';
    }
    .container {
        display:block;
        margin-left: -120px;
        width:240px;
        position:absolute;
        left:50%;
        top:30px;
    }
    .box {
        display:none;
        border: solid 1px #CCCCFF;
        padding: 16px;
        border-radius: 12px;
        background:white;
    }
    .box ul li {
        list-style:none;
        padding-bottom:6px;
    }
    .box ul {
        padding:0;
    }
    .box h3 {
        margin:0;
    }
    .help-icon {
        background: #AAAAFF;
        border-radius:50%;
        display:inline-block;
        width:18px;
        height:18px;
        text-align:center;
        font-size:14px;
    }
    .box input {
        border:solid 1px #aaa;
        border-radius:4px;
        padding: 4px 6px;
    }
    .box lable {
        display:block;
        font-size:14;
        font-weight: bold;
    }
    #messagebox {
        padding: 6px;
        display: block;
        border:none;
    }
</style>
